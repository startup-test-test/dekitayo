# ヘッドレスCMS構築手順

## 概要

WordPress（Xserver）+ Next.js（Vercel）のヘッドレスCMS構成を構築する手順書

---

## 構成図

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  WordPress（CMS）           Next.js（フロント）          │
│  cms.dekitayo.jp    ───→   dekitayo.jp                 │
│  Xserver                    Vercel                      │
│                                                         │
│  ・コンテンツ管理            ・表示・UI                  │
│  ・GraphQL API提供           ・SSG/ISR                  │
│  ・非公開（Basic認証）        ・公開サイト               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Phase 1：インフラ準備

### 1-1. ドメイン設定

| 手順 | 作業内容 | 備考 |
|------|---------|------|
| 1 | ドメイン取得 | dekitayo.jp（ムームードメイン） |
| 2 | ネームサーバー変更 | Xserverに向ける |
| 3 | サブドメイン作成 | cms.dekitayo.jp |
| 4 | DNS反映確認 | 1〜2時間待つ |

### 1-2. サーバー設定

| 手順 | 作業内容 | 備考 |
|------|---------|------|
| 1 | SSL設定 | cms.dekitayo.jp に無料SSL適用 |
| 2 | Basic認証設定 | サーバーパネル → アクセス制限 |

---

## Phase 2：WordPress構築

### 2-1. WordPressインストール

**Xserverサーバーパネルから：**

1. 「WordPress簡単インストール」をクリック
2. 対象ドメイン：`cms.dekitayo.jp` を選択
3. 以下を入力：
   - サイトURL：そのまま（サブディレクトリ空欄）
   - ブログ名：「できたよ！CMS」
   - ユーザー名：任意（推測されにくいもの）
   - パスワード：強力なもの
   - メールアドレス：管理者メール
4. 「インストール」をクリック

### 2-2. WordPress初期設定

管理画面（`https://cms.dekitayo.jp/wp-admin/`）にログイン後：

| 設定項目 | 操作 |
|---------|------|
| 設定 → 一般 | サイトのタイトル確認 |
| 設定 → 表示設定 | 「検索エンジンがサイトをインデックスしないようにする」に✅ |
| 設定 → パーマリンク | 「投稿名」を選択 |
| プラグイン | Hello Dolly を削除 |
| テーマ | 使わないテーマを削除（Twenty Twenty-Fourのみ残す） |

### 2-3. セキュリティ設定

| 設定項目 | 操作 |
|---------|------|
| ユーザー → プロフィール | ニックネームをユーザー名と別にする |
| 設定 → ディスカッション | コメント機能を無効化 |

---

## Phase 3：プラグインインストール

### 3-1. 必須プラグイン

| プラグイン | 用途 | インストール方法 |
|-----------|------|-----------------|
| WPGraphQL | GraphQL API提供 | プラグイン検索 |
| Advanced Custom Fields | カスタムフィールド | プラグイン検索 |
| WPGraphQL for ACF | ACFをGraphQL対応 | GitHub からダウンロード |

### 3-2. WPGraphQLインストール手順

1. プラグイン → 新規追加
2. 「WPGraphQL」で検索
3. インストール → 有効化
4. 左メニューに「GraphQL」が追加される
5. GraphQL → Settings で確認
   - GraphQL Endpoint: `https://cms.dekitayo.jp/graphql`

### 3-3. ACFインストール手順

1. プラグイン → 新規追加
2. 「Advanced Custom Fields」で検索
3. インストール → 有効化
4. 左メニューに「ACF」が追加される

### 3-4. WPGraphQL for ACFインストール手順

1. https://github.com/wp-graphql/wpgraphql-acf/releases から最新版をダウンロード
2. プラグイン → 新規追加 → プラグインのアップロード
3. ZIPファイルをアップロード → インストール → 有効化

### 3-5. 推奨プラグイン

| プラグイン | 用途 |
|-----------|------|
| Yoast SEO | SEOメタデータ管理 |
| WPGraphQL for Yoast SEO | YoastをGraphQL対応 |

---

## Phase 4：コンテンツ設計

### 4-1. 投稿タイプ

| 投稿タイプ | 用途 | 備考 |
|-----------|------|------|
| 投稿（post） | ブログ記事 | WordPress標準 |
| 固定ページ（page） | 静的ページ | WordPress標準 |
| 教室（classroom） | プログラミング教室 | カスタム投稿タイプ |

### 4-2. カスタム投稿タイプ作成（教室）

ACFまたはコードで作成：

```php
// functions.php に追加
function create_classroom_post_type() {
    register_post_type('classroom', array(
        'labels' => array(
            'name' => '教室',
            'singular_name' => '教室',
        ),
        'public' => true,
        'has_archive' => true,
        'show_in_graphql' => true,  // WPGraphQL対応
        'graphql_single_name' => 'classroom',
        'graphql_plural_name' => 'classrooms',
        'supports' => array('title', 'editor', 'thumbnail'),
    ));
}
add_action('init', 'create_classroom_post_type');
```

### 4-3. ACFフィールドグループ（教室）

| フィールド名 | フィールドタイプ | 説明 |
|-------------|----------------|------|
| classroom_name | テキスト | 教室名 |
| classroom_address | テキスト | 住所 |
| classroom_phone | テキスト | 電話番号 |
| classroom_url | URL | 公式サイトURL |
| classroom_description | テキストエリア | 説明文 |
| classroom_features | チェックボックス | 特徴（Scratch対応等） |
| classroom_area | セレクト | 地域 |
| classroom_google_rating | 数値 | Google評価 |
| classroom_google_review_count | 数値 | 口コミ数 |

---

## Phase 5：GraphQL API確認

### 5-1. GraphiDE（テスト画面）

`https://cms.dekitayo.jp/graphql` にアクセス、またはWordPress管理画面の GraphQL → GraphiQL IDE

### 5-2. テストクエリ

```graphql
# 投稿一覧を取得
query GetPosts {
  posts {
    nodes {
      id
      title
      slug
      date
      excerpt
    }
  }
}
```

```graphql
# 教室一覧を取得（カスタム投稿タイプ作成後）
query GetClassrooms {
  classrooms {
    nodes {
      id
      title
      slug
    }
  }
}
```

### 5-3. 認証設定（公開API）

WPGraphQL Settings で：
- Public Introspection: Enabled
- GraphQL Endpoint: `/graphql`

**注意**: Basic認証がかかっている場合、外部からのAPIアクセスも認証が必要になる。Next.jsから呼び出す際は認証情報を渡す必要あり。

---

## Phase 6：Next.js連携

### 6-1. Next.jsプロジェクト作成

```bash
npx create-next-app@latest dekitayo-frontend --typescript --tailwind --app
cd dekitayo-frontend
```

### 6-2. 環境変数設定

`.env.local` を作成：

```
WORDPRESS_API_URL=https://cms.dekitayo.jp/graphql
WORDPRESS_AUTH_USER=Basic認証ユーザー名
WORDPRESS_AUTH_PASS=Basic認証パスワード
```

### 6-3. GraphQLクライアント設定

```bash
npm install graphql-request graphql
```

```typescript
// lib/wordpress.ts
import { GraphQLClient } from 'graphql-request';

const endpoint = process.env.WORDPRESS_API_URL!;

// Basic認証が必要な場合
const auth = Buffer.from(
  `${process.env.WORDPRESS_AUTH_USER}:${process.env.WORDPRESS_AUTH_PASS}`
).toString('base64');

export const client = new GraphQLClient(endpoint, {
  headers: {
    Authorization: `Basic ${auth}`,
  },
});
```

### 6-4. データ取得例

```typescript
// lib/queries.ts
import { gql } from 'graphql-request';

export const GET_POSTS = gql`
  query GetPosts {
    posts(first: 10) {
      nodes {
        id
        title
        slug
        date
        excerpt
      }
    }
  }
`;
```

```typescript
// app/blog/page.tsx
import { client } from '@/lib/wordpress';
import { GET_POSTS } from '@/lib/queries';

export default async function BlogPage() {
  const data = await client.request(GET_POSTS);

  return (
    <div>
      {data.posts.nodes.map((post) => (
        <article key={post.id}>
          <h2>{post.title}</h2>
        </article>
      ))}
    </div>
  );
}
```

---

## Phase 7：Vercelデプロイ

### 7-1. GitHubリポジトリ作成

```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/xxx/dekitayo-frontend.git
git push -u origin main
```

### 7-2. Vercel連携

1. https://vercel.com にログイン
2. 「New Project」→ GitHubリポジトリを選択
3. 環境変数を設定（.env.localと同じ内容）
4. デプロイ

### 7-3. カスタムドメイン設定

1. Vercelプロジェクト → Settings → Domains
2. `dekitayo.jp` を追加
3. DNSレコードを設定（ムームードメインorXserver）

---

## トラブルシューティング

### GraphQLが動かない

| 症状 | 対処 |
|------|------|
| 404エラー | パーマリンク設定を保存し直す |
| 認証エラー | Basic認証の情報を確認 |
| CORSエラー | WPGraphQL設定でCORSを許可 |

### ACFフィールドがGraphQLに出ない

1. ACFフィールドグループ設定で「Show in GraphQL」を有効化
2. WPGraphQL for ACF がインストール・有効化されているか確認

### 画像が取得できない

- メディアのURLがcms.dekitayo.jpになっている
- Next.jsのnext.config.jsでドメインを許可する必要あり

```javascript
// next.config.js
module.exports = {
  images: {
    domains: ['cms.dekitayo.jp'],
  },
};
```

---

## 参考リンク

- [WPGraphQL公式](https://www.wpgraphql.com/)
- [ACF公式](https://www.advancedcustomfields.com/)
- [Next.js公式](https://nextjs.org/)
- [Vercel公式](https://vercel.com/)
